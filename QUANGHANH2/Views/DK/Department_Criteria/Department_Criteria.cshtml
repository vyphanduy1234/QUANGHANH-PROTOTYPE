
@{
    ViewBag.Title = "Department_Criteria";
    Layout = "~/Views/Shared/_Layout_DK.cshtml";
}

<link href="~/assets/Custom css/TABLE_BORDERED.css" rel="stylesheet" />
<link href="~/assets/Custom css/form-input-border.css" rel="stylesheet" />
<link href="~/assets/libs/toastr/build/toastr.min.css" rel="stylesheet">
<style>
    #toast-container {
        min-width: 10%;
        top: 0;
        right: 50%;
        transform: translateX(50%) translateY(50%);
    }

    #export-button {
        float: right !important;
    }
</style>
<div class="card">
    <div class="card-content">
        <h3 class="center">TIÊU CHÍ CHO PHÒNG BAN</h3>
        <div class="row">
            <div class="input-field col l1 m12 s12">
            </div>
            <div class="input-field col l3 m12 s12">
                <input type="text" id="monthCalendar" class="form-control datepicker-here datepicker-add center"
                       data-language='vi'
                       data-min-view="months"
                       data-view="months"
                       data-date-format="Tháng mm"
                       required placeholder="Tháng" />
            </div>
            <div class="input-field col l3 m12 s12">
                <input type="text" id="yearCalendar" class="form-control datepicker-here datepicker-add center"
                       data-language='vi'
                       data-min-view="years"
                       data-view="years"
                       data-date-format="Năm yyyy"
                       required placeholder="Năm" />
            </div>
            <div class="input-field col l3 m12 s12">
                <select class="form-control" id="cbx-px" name="px_value">
                    <option value="default-px" disabled selected>Phân xưởng</option>
                    <option value="PXKT1">Khai thác 1</option>
                    <option value="PXKT2">Khai thác 2</option>
                    <option value="PXKT3">Khai thác 3</option>
                    <option value="PXKT4">Khai thác 4</option>
                    <option value="PXKT5">Khai thác 5</option>
                    <option value="PXKT6">Khai thác 6</option>
                    <option value="PXKT7">Khai thác 7</option>
                    <option value="PXKT8">Khai thác 8</option>
                    <option value="PXKT9">Khai thác 9</option>
                    <option value="PXKT10">Khai thác 10</option>
                    <option value="PXKT11">Khai thác 11</option>
                    <option value="PXDL3">Đào lò 3</option>
                    <option value="PXDL5">Đào lò 5</option>
                    <option value="PXDL7">Đào lò 7</option>
                    <option value="PXDL8">Đào lò 8</option>
                    <option value="PXDL2">Thăng Long</option>
                    <option value="CTA">Asean</option>
                    <option value="PXDL1">Xây lắp mỏ</option>
                    <option value="PXST">Sàng tuyển</option>
                    <option value="PXLT">Lộ thiên</option>
                    <option value="KCS">KCS</option>
                </select>
            </div>
            <div class="input-field col l1 m12 s12">
                <a class="btn blue darken-2 right" onclick="getInformation()">XEM</a>
            </div>
            <div class="input-field col l1 m12 s12">
            </div>
            <div class="row">
                <div class="col s12 m12 l12">
                    <table class="table-bordered" id="aspectDetailTable">
                        <thead>
                            <tr>
                                <th>Tiêu chí</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="col s12 m12 l12 input-field right row">
                    <a class="btn blue darken-2" id="addRowsbtn">Thêm</a>
                </div>

            </div>
            <div class="col s12 m12 l12 input-field center row">
                <button class="btn blue darken-2" type="submit" id="EditSaveBtn" onclick="EditOrUpdate()">CHỈNH SỬA</button>
            </div>
        </div>
    </div>
</div>

<!--ADD ROW-->
<script>
    $(document).ready(function () {
        $('select').formSelect();
        mode = 0;
        $('#addRowsbtn').hide();
        listAspectDepartments = [];
    });
    var dem = 0;

    /////////////////////Button Thêm/////////////////////
    $("#addRowsbtn").on("click", function () {
        content = "";
        selectContent = "<select id=\"MaTieuChi" + dem + "\" onchange=\"return checkDuplicate(this);\" class=\"browser-default\" skipped=\"0\"> <option value=\"-1\" selected disabled>Lựa chọn tiêu chí</option>";

        for (let i = 0; i < listAspectDepartments.length; i++) {
            selectContent += "<option id=\"" + listAspectDepartments[i].MaTieuChi + "\" value=\"" + listAspectDepartments[i].MaTieuChi + "\">" + listAspectDepartments[i].TenTieuChi + "</option>";
        }
        selectContent += "</select>";
        content += "<tr id=\"MaTieuChi" + dem + "\"><td>" + selectContent + "</td><td><a id='delete-btn' name=\"MaTieuChi" + dem + "\" class='btn red darken-2'>Xóa</a></td></tr>";
        dem++;
        tableBody.append(content);
    });

    /////////////////////Button Xóa///////////////////////
    $("#aspectDetailTable").on("click", "#delete-btn", function () {
        $("tr#" + $(this).attr("name")).remove();
        emptyArr();
        $("#aspectDetailTable").find("select").each(function () {
            var value = $(this).val();
            if (value != null) {
                if (value !== -1 || currentSelectedValue.indexOf(value) !== -1) {
                    currentSelectedValue.push(value);
                }
            }
        })
        dem--;
    })
</script>


<!--LIST + ADD + UPDATE + DELETE-->
<script>
    function getInformation() {
        dem = 0;
        if ($('#monthCalendar').val() == "" || $('#yearCalendar').val() == "" || $('#cbx-px').val() == null)
            return false;
        $('#pre-load').show();
        console.log($("#monthCalendar").val().split(" ")[1]);
        console.log($("#yearCalendar").val().split(" ")[1]);
        console.log($("#cbx-px").val());
        $.ajax({
            type: 'post',
            url: '/phong-dieu-khien/nhap-lieu-phong-ban-tieu-chi/lay-thong-tin',
            data: {
                'month': $("#monthCalendar").val().split(" ")[1],
                'year': $("#yearCalendar").val().split(" ")[1],
                'department': $("#cbx-px").val(),
            },
            success: function (response) {
                tableBody = $("#aspectDetailTable").children("tbody");
                tableBody.empty();
                content = "";
                let reponseListPhongBanTieuChi = response.listPhongBanTieuChi
                for (let i = 0; i < reponseListPhongBanTieuChi.length; i++) {
                    content += "<tr><td class=\"aspectName\" id=\"" + reponseListPhongBanTieuChi[i].MaTieuChi + "\">" + reponseListPhongBanTieuChi[i].TenTieuChi + "</td><td><a class='btn red darken-2' onclick='deleteInformation(" + reponseListPhongBanTieuChi[i].MaTieuChi + ")'>Xóa</a></td><tr>";
                }
                tableBody.html(content);
                ViewMode();
                mode = 0;
                listAspectDepartments = response.listTieuChi;
                $('#pre-load').hide();
            },
            error: function (response) {

            }
        })
    }

    function check() {
        tableBodyRows = $("#aspectDetailTable tbody tr")
            .each(function () {
                $(this).find("td").each(function (i, v) {
                    console.log($(this).val)
                })
            });
    }

    function ViewMode() {
        $("#EditSaveBtn").html("<i class=\"material-icons right\">border_color</i>CẬP NHẬT");
        $('#addRowsbtn').hide();
        $("#totalDays").attr("disable", true)
    }

    function EditMode() {
        $("#EditSaveBtn").html("<i class=\"material-icons right\">border_color</i>LƯU");
        $('#addRowsbtn').show();
        $("#totalDays").removeAttr("disabled")
    }

    function EditOrUpdate() {
        if (mode == 0) {
            //View Mode -> Edit
           
            EditMode();
            
            $('.editableContent').each(function () {
                content = $(this).text();
                console.log($(this).attr("id"))
                if ($(this).attr("id").includes("amount")) {
                    $(this).html("<input type=\"number\" value=\"" + content + "\">")
                } else {
                    $(this).html("<input type=\"text\" value=\"" + content + "\">")
                }
            })

        } else {
            // Edit Mode -> View
            sendUpdateData();
            ViewMode();
        }
        mode = 1 - mode;
    }

    function sendUpdateData() {
        setTimeout($('#pre-load').show(), 3000)
        $.ajax({
            url: "/phong-dieu-khien/nhap-lieu-phong-ban-tieu-chi/cap-nhat-thong-tin",
            type: "post",
            data: {
                'month': $("#monthCalendar").val().split(" ")[1],
                'year': $("#yearCalendar").val().split(" ")[1],
                'department': $("#cbx-px").val(),
                'currentSelectedValue': JSON.stringify(currentSelectedValue)
            },
            success: function (response) {
                successAlert('Thành công', 'Thao tác thành công');
                getInformation();
                $('#pre-load').hide();
            },
            error: function (response) {
                errorAlert('Lỗi', 'Có lỗi xảy ra , vui lòng nhập lại.');
                $('#pre-load').hide();
            }
        })
    }

    function deleteInformation(MaTieuChi) {
        confirmAlert("Xác nhận xóa?", "", function () {
             setTimeout($('#pre-load').show(), 3000);
        $.ajax({
            url: "/phong-dieu-khien/nhap-lieu-phong-ban-tieu-chi/xoa-tieu-chi-cua-phong-ban",
            type: "post",
            //dataType: "json",
            data: {
                'month': $("#monthCalendar").val().split(" ")[1],
                'year': $("#yearCalendar").val().split(" ")[1],
                'department': $("#cbx-px").val(),
                'criteria': MaTieuChi
            },
            success: function (response) {
                successAlert('Thành công', 'Thao tác thành công');
                getInformation();
                $('#pre-load').hide();
            },
            error: function (response) {
                errorAlert('Lỗi', 'Có lỗi xảy ra, không thể xóa.');
                $('#pre-load').hide();
            }
        })
        })
    }

</script>

<!--VALIDATE-->
<script>
    var currentSelectedValue = [];
    var selectedValueTD = [];

    function emptyArr() {
        currentSelectedValue = [];
        selectedValueTD = [];
    }

    $("#aspectDetailTable").on("click", "select", function () {
        emptyArr();
        //////Push to array after empty//////
        $("#aspectDetailTable").find("select").each(function () {
            var value = $(this).val();
            if (value != null) {
                if (value !== -1 || currentSelectedValue.indexOf(value) !== -1) {
                    currentSelectedValue.push(value);
                }
            }
        })
        ///////////
        $("#aspectDetailTable").find("td").each(function () {
            var value = $(this).attr('id');
            if (value != null) {
                if (value !== -1 || selectedValueTD.indexOf(value) !== -1) {
                    selectedValueTD.push(value);
                }
            }
        })
    });

    function checkDuplicate(selectTag) {
        selectedValue = selectTag.options[selectTag.selectedIndex].value;
        if (currentSelectedValue.indexOf(selectedValue) !== -1 || selectedValueTD.indexOf(selectedValue) !== -1) {
            selectTag.value = '-1';
            toastr.error('Tiêu chí này đã tồn tại', '');
        }
    }
</script>
<script src="~/lib/datepicker_src/dist/js/i18n/datepicker.vi.js"></script>
<script src="~/js/Custom JS/Disable_input_material.js"></script>
<script src="~/js/Custom JS/form-input-border.js"></script>
<script src="~/assets/libs/toastr/build/toastr.min.js"></script>
<script src="~/assets/extra-libs/toastr/toastr-init.js"></script>



